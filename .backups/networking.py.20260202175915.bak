import requests
import socket
import logging

class NetworkManager:
    """
    Module for handling external network communications and connectivity checks.
    """
    def __init__(self):
        self.logger = logging.getLogger("Genesis.Network")
        self.session = requests.Session()

    def fetch_url(self, url, method="GET", payload=None):
        """
        Safely fetches data from a URL.
        """
        try:
            self.logger.info(f"Fetching {url} via {method}")
            if method.upper() == "GET":
                response = self.session.get(url, timeout=10)
                response.raise_for_status()
                return {"status": response.status_code, "data": response.text}
            elif method.upper() == "POST":
                response = self.session.post(url, json=payload, timeout=10)
                response.raise_for_status()
                return {"status": response.status_code, "data": response.text}
        except requests.exceptions.RequestException as e:
            self.logger.error(f"Network Request Failed: {e}")
            return {"status": 500, "error": str(e)}
        return None

    def ping_host(self, host):
        """
        Checks basic TCP connectivity to a host.
        """
        try:
            socket.create_connection((host, 80), timeout=5)
            return True
        except OSError:
            return False

    def send_tcp_data(self, host, port, data):
        """
        Sends raw data over TCP socket.
        """
        try:
            with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as s:
                s.connect((host, port))
                s.sendall(data.encode('utf-8'))
                return True
        except Exception as e:
            self.logger.error(f"TCP Send Failed: {e}")
            return False

    def scan_port(self, host, port):
        """
        Checks if a specific port is open on the target host.
        """
        try:
            with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as s:
                s.settimeout(1)
                result = s.connect_ex((host, port))
                return result == 0
        except:
            return False